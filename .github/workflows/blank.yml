name: "Sonar: SonarQube Web"

on:
  push:
    branches:
      - main  # or the branch you are merging into
    paths:
      - './backend/**'
      - './frontend/**'

permissions:
  id-token: write
  contents: read

jobs:
  Sonar-Scan:
    name: SonarQube Scan for Web Application Code  
    runs-on: ubuntu-latest
    if: github.event.head_commit.message contains 'Merge pull request'  # Only run if the commit message indicates a merge
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Determine Working Directory
        run: |
          working_dir="${{ github.event.head_commit.message == 'Merge pull request' && './backend' || './frontend' }}"
          echo "Working Directory: $working_dir"

      # Backend Steps
      - name: Set Up Python for Backend
        if: github.event.head_commit.message contains 'backend'
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install Dependencies for Backend
        if: github.event.head_commit.message contains 'backend'
        run: python -m pip install -r backend/requirements.txt

      - name: Run Python Unit Tests for Backend
        if: github.event.head_commit.message contains 'backend'
        run: |
          echo "Running Python Unit Tests in $working_dir"
          # Uncomment the line below to actually run the tests
          # pytest backend --cov=backend --cov-report=xml

      # Frontend Steps
      - name: Set Up Node.js for Frontend
        if: github.event.head_commit.message contains 'frontend'
        uses: actions/setup-node@v3
        with:
          node-version: '18.x'

      - name: Install Dependencies for Frontend
        if: github.event.head_commit.message contains 'frontend'
        run: npm ci

      - name: Run Angular Unit Tests with Coverage
        if: github.event.head_commit.message contains 'frontend'
        run: |
          echo "Running Angular Unit Tests in $working_dir"
          # Uncomment the line below to actually run the tests
          # npm run test -- --code-coverage --watch=false
